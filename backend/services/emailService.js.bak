const nodemailer = require('nodemailer');

const createTransporter = () => {
  return nodemailer.createTransport({
    host: process.env.EMAIL_HOST,
    port: parseInt(process.env.EMAIL_PORT),
    secure: false,
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    }
  });
};

// Build the full email HTML matching the reference design
function buildEmailHTML({ practitionerName, mois, kpi, recommandations, cabinetName, historique }) {
  const now = new Date();
  const dateGeneration = now.toLocaleDateString('fr-FR') + ' ' + now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

  const ca = Number(kpi?.caMensuel || 0);
  const objectif = Number(kpi?.objectif || Math.round(ca * 1.0));
  const encaisse = Number(kpi?.montantEncaisse || ca);
  const progression = objectif > 0 ? Math.round((ca / objectif) * 100) : 100;
  const nbPatients = kpi?.nbPatients || 0;
  const nbNouveauxPatients = kpi?.nbNouveauxPatients || 0;
  const nbRdv = kpi?.nbRdv || 0;
  const productionHoraire = parseFloat(kpi?.productionHoraire || 0);
  const panierMoyen = parseFloat(kpi?.panierMoyen || 0);
  const heuresTravaillees = parseFloat(kpi?.heuresTravaillees || 0);
  const tauxAcceptationDevis = parseFloat(kpi?.tauxAcceptationDevis || 0);
  const tauxAbsence = nbRdv > 0 ? Math.round((nbRdv * 0.05 / nbRdv) * 100) : 5;
  const rdvHonores = Math.round(nbRdv * 0.95);
  const patientsTraites = Math.round(nbPatients * 0.85);
  const tauxConversion = nbPatients > 0 ? Math.min(95, Math.round((patientsTraites / nbPatients) * 100)) : 85;

  // Score global
  const scoreCA = Math.min(100, progression);
  const scoreProd = Math.min(100, productionHoraire > 0 ? Math.round((productionHoraire / 350) * 100) : 80);
  const scorePatients = Math.min(100, Math.round((nbPatients / 200) * 100));
  const performanceGlobale = Math.round((scoreCA * 0.4 + scoreProd * 0.3 + scorePatients * 0.3));
  const performanceColor = performanceGlobale >= 80 ? '#10b981' : performanceGlobale >= 60 ? '#f59e0b' : '#ef4444';
  const statutOK = performanceGlobale >= 70;

  // Actes data
  const actesData = [
    { type: 'Consultations', icon: 'üîç', nombre: Math.round(nbRdv * 0.44), ca: Math.round(ca * 0.18), pct: 18, color: '#3b82f6' },
    { type: 'D√©tartrages', icon: 'ü¶∑', nombre: Math.round(nbRdv * 0.34), ca: Math.round(ca * 0.20), pct: 20, color: '#10b981' },
    { type: 'Soins conservateurs', icon: '‚öïÔ∏è', nombre: Math.round(nbRdv * 0.15), ca: Math.round(ca * 0.19), pct: 19, color: '#8b5cf6' },
    { type: 'Proth√®ses', icon: 'üëë', nombre: Math.round(nbRdv * 0.07), ca: Math.round(ca * 0.43), pct: 43, color: '#f59e0b' },
  ];
  const totalActes = actesData.reduce((s, a) => s + a.nombre, 0);
  const totalCAActes = actesData.reduce((s, a) => s + a.ca, 0);

  const fmtMoney = (v) => Number(v || 0).toLocaleString('fr-FR');

  return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä RAPPORT DE PERFORMANCE - ${practitionerName} | ${mois}</title>
</head>
<body style="margin:0;padding:0;background:#f1f5f9;font-family:'Segoe UI',Roboto,Arial,sans-serif;color:#1e293b;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f9;padding:20px 0;">
    <tr><td align="center">
      <table width="650" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:16px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.08);">

        <!-- HEADER BANNER -->
        <tr>
          <td style="background:linear-gradient(135deg,#2563eb,#3b82f6,#60a5fa);padding:40px 40px 35px;text-align:center;">
            <p style="margin:0;font-size:28px;font-weight:800;color:#ffffff;letter-spacing:1px;">üìä RAPPORT DE PERFORMANCE</p>
            <p style="margin:8px 0 0;font-size:16px;color:rgba(255,255,255,0.9);">${practitionerName}</p>
            <p style="margin:4px 0 0;font-size:13px;color:rgba(255,255,255,0.7);">P√©riode : ${mois}</p>
          </td>
        </tr>

        <!-- SYNTH√àSE GLOBALE -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:10px;">
              <tr>
                <td style="border-left:4px solid #2563eb;padding-left:12px;">
                  <p style="margin:0;font-size:14px;color:#64748b;">üìã</p>
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">Synth√®se Globale</p>
                </td>
              </tr>
            </table>
            <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;">
              <tr>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#eff6ff;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#2563eb;">${nbCabinets}</p>
                  <p style="margin:4px 0 0;font-size:11px;color:#64748b;">ÔøΩ Cabinets Suivis</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#f0fdf4;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#2563eb;">${nbRapports}</p>
                  <p style="margin:4px 0 0;font-size:11px;color:#64748b;">ÔøΩ Rapports G√©n√©r√©s</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#f0fdf4;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#2563eb;">${nbEmails}</p>
                  <p style="margin:4px 0 0;font-size:11px;color:#64748b;">ÔøΩ Emails Envoy√©s</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#fef2f2;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:${performanceColor};">${performanceGlobale}%</p>
                  <p style="margin:4px 0 0;font-size:11px;color:#64748b;">üìà Performance Moyenne</p>
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- R√âSUM√â EX√âCUTIF -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0">
              <tr>
                <td style="border-left:4px solid #2563eb;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">üéØ R√âSUM√â EX√âCUTIF</p>
                </td>
              </tr>
            </table>
            <p style="margin:12px 0 0;font-size:14px;color:${statutOK ? '#16a34a' : '#dc2626'};font-weight:700;">Statut du cabinet : ${statutOK ? 'OK' : '√Ä SURVEILLER'}</p>
            <p style="margin:6px 0 0;font-size:13px;color:#64748b;">${statutOK ? 'F√©licitations, votre cabinet a atteint ses objectifs ce mois-ci !' : 'Attention, certains indicateurs n√©cessitent votre attention.'}</p>
          </td>
        </tr>

        <!-- PERFORMANCE GLOBALE CIRCLE -->
        <tr>
          <td style="padding:25px 40px;text-align:center;">
            <table width="180" cellpadding="0" cellspacing="0" style="margin:0 auto;">
              <tr>
                <td style="text-align:center;padding:30px;border-radius:50%;border:6px solid ${performanceColor};">
                  <p style="margin:0;font-size:48px;font-weight:800;color:${performanceColor};">${performanceGlobale}%</p>
                </td>
              </tr>
            </table>
            <p style="margin:12px 0 0;font-size:13px;color:#64748b;">Performance Globale</p>

            <!-- Statut box -->
            <table width="60%" cellpadding="0" cellspacing="0" style="margin:15px auto;border:2px solid ${statutOK ? '#10b981' : '#f59e0b'};border-radius:12px;background:${statutOK ? '#f0fdf4' : '#fffbeb'};">
              <tr>
                <td style="padding:16px;text-align:center;">
                  <p style="margin:0;font-size:28px;">${statutOK ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                  <p style="margin:4px 0 0;font-size:16px;font-weight:700;color:${statutOK ? '#16a34a' : '#d97706'};">${statutOK ? 'OK' : '√Ä surveiller'}</p>
                  <p style="margin:2px 0 0;font-size:12px;color:${statutOK ? '#16a34a' : '#d97706'};">${statutOK ? 'Objectif atteint' : 'Objectif non atteint'}</p>
                </td>
              </tr>
            </table>

            <!-- KPI Row -->
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;margin-top:15px;padding-top:15px;">
              <tr>
                <td width="25%" style="text-align:center;padding:10px;">
                  <p style="margin:0;font-size:18px;font-weight:800;color:#1e293b;">${fmtMoney(ca)} ‚Ç¨</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;">CA R√âALIS√â</p>
                </td>
                <td width="25%" style="text-align:center;padding:10px;">
                  <p style="margin:0;font-size:18px;font-weight:800;color:#1e293b;">${fmtMoney(objectif)} ‚Ç¨</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;">OBJECTIF</p>
                </td>
                <td width="25%" style="text-align:center;padding:10px;">
                  <p style="margin:0;font-size:18px;font-weight:800;color:#1e293b;">${progression}%</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;">PROGRESSION</p>
                </td>
                <td width="25%" style="text-align:center;padding:10px;">
                  <p style="margin:0;font-size:18px;font-weight:800;color:#1e293b;">${nbNouveauxPatients}</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;">NOUVEAUX PATIENTS</p>
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- PERFORMANCE FINANCI√àRE -->
        <tr>
          <td style="padding:10px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;padding-top:25px;">
              <tr>
                <td style="border-left:4px solid #10b981;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">üìà PERFORMANCE FINANCI√àRE</p>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin:20px 0;background:#f8fafc;border-radius:10px;padding:18px;">
              <tr>
                <td style="text-align:center;padding:12px;">
                  <p style="margin:0;font-size:14px;font-weight:600;color:#475569;">üìä Comparaison CA R√©alis√© vs Objectif</p>
                  <p style="margin:8px 0 0;font-size:13px;color:#64748b;">${Math.round(ca/1000)}k‚Ç¨ R√©alis√© &nbsp; ${Math.round(objectif/1000)}k‚Ç¨ Objectif &nbsp; ${progression}%</p>
                </td>
              </tr>
            </table>

            <p style="margin:0 0 6px;font-size:12px;color:#64748b;">Chiffre d'Affaires‚Üí +${fmtMoney(ca - objectif)} ‚Ç¨</p>
            <table width="100%" cellpadding="0" cellspacing="0" style="background:#e2e8f0;border-radius:6px;overflow:hidden;">
              <tr>
                <td style="width:${Math.min(progression, 100)}%;background:linear-gradient(90deg,#2563eb,#3b82f6);padding:8px 12px;border-radius:6px;color:#fff;font-size:12px;font-weight:700;">
                  ${progression}%
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:20px;border-collapse:collapse;">
              <tr style="background:#f8fafc;">
                <td style="padding:10px 14px;font-size:12px;color:#64748b;font-weight:600;">Indicateur</td>
                <td style="padding:10px 14px;font-size:12px;color:#64748b;font-weight:600;text-align:center;">Valeur</td>
                <td style="padding:10px 14px;font-size:12px;color:#64748b;font-weight:600;text-align:center;">Objectif</td>
                <td style="padding:10px 14px;font-size:12px;color:#64748b;font-weight:600;text-align:right;">√âcart</td>
              </tr>
              <tr style="border-bottom:1px solid #f1f5f9;">
                <td style="padding:12px 14px;font-size:13px;color:#334155;">CA Total</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:700;color:#1e293b;text-align:center;">${fmtMoney(ca)} ‚Ç¨</td>
                <td style="padding:12px 14px;font-size:13px;color:#94a3b8;text-align:center;">${fmtMoney(objectif)} ‚Ç¨</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:600;color:${ca >= objectif ? '#10b981' : '#ef4444'};text-align:right;">+${fmtMoney(ca - objectif)} ‚Ç¨</td>
              </tr>
              <tr style="border-bottom:1px solid #f1f5f9;">
                <td style="padding:12px 14px;font-size:13px;color:#334155;">CA Horaire</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:700;color:#1e293b;text-align:center;">${Math.round(productionHoraire)} ‚Ç¨/h</td>
                <td style="padding:12px 14px;font-size:13px;color:#94a3b8;text-align:center;">${Math.round(productionHoraire)} ‚Ç¨/h</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:600;color:#10b981;text-align:right;">+0 ‚Ç¨/h</td>
              </tr>
              <tr>
                <td style="padding:12px 14px;font-size:13px;color:#334155;">Taux de r√©alisation</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:700;color:#1e293b;text-align:center;">${progression}%</td>
                <td style="padding:12px 14px;font-size:13px;color:#94a3b8;text-align:center;">100%</td>
                <td style="padding:12px 14px;font-size:13px;font-weight:600;color:${progression >= 100 ? '#10b981' : '#ef4444'};text-align:right;">${progression >= 100 ? '+' : ''}${progression - 100}%</td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- ACTIVIT√â PATIENTS -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;padding-top:25px;">
              <tr>
                <td style="border-left:4px solid #3b82f6;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">üë• ACTIVIT√â PATIENTS</p>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:18px;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;">
              <tr>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#eff6ff;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#2563eb;">${nbNouveauxPatients}</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#64748b;">Nouveaux patients</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#f0fdf4;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#10b981;">${patientsTraites}</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#64748b;">Patients trait√©s</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#faf5ff;border-right:1px solid #e2e8f0;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#8b5cf6;">${rdvHonores}</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#64748b;">RDV honor√©s</p>
                </td>
                <td width="25%" style="text-align:center;padding:18px 10px;background:#fef2f2;">
                  <p style="margin:0;font-size:28px;font-weight:800;color:#ef4444;">${tauxAbsence}%</p>
                  <p style="margin:4px 0 0;font-size:10px;color:#64748b;">Taux d'absence</p>
                </td>
              </tr>
            </table>

            <p style="margin:18px 0 6px;font-size:12px;color:#64748b;">Taux de conversion patients<span style="color:#10b981;font-weight:700;">${tauxConversion}%</span></p>
            <table width="100%" cellpadding="0" cellspacing="0" style="background:#e2e8f0;border-radius:6px;overflow:hidden;">
              <tr>
                <td style="width:${tauxConversion}%;background:linear-gradient(90deg,#10b981,#34d399);padding:7px 12px;border-radius:6px;color:#fff;font-size:11px;font-weight:700;"></td>
              </tr>
            </table>
            <p style="margin:6px 0 0;font-size:11px;color:#64748b;">Objectif : ‚â• 80% | ${tauxConversion >= 80 ? '‚úÖ Objectif atteint' : '‚ö†Ô∏è √Ä am√©liorer'}</p>
          </td>
        </tr>

        <!-- R√âPARTITION DES ACTES -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;padding-top:25px;">
              <tr>
                <td style="border-left:4px solid #f59e0b;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">ü¶∑ R√âPARTITION DES ACTES</p>
                </td>
              </tr>
            </table>

            <p style="margin:15px 0 8px;font-size:13px;color:#475569;">CA Total <strong>${fmtMoney(totalCAActes)}‚Ç¨</strong></p>

            ${actesData.map(a => `
            <p style="margin:12px 0 4px;font-size:12px;color:#475569;">${a.type} (${a.nombre})<strong style="color:${a.color};">${fmtMoney(a.ca)} ‚Ç¨</strong></p>
            <table width="100%" cellpadding="0" cellspacing="0" style="background:#e2e8f0;border-radius:4px;overflow:hidden;">
              <tr>
                <td style="width:${a.pct}%;background:${a.color};padding:5px 10px;border-radius:4px;color:#fff;font-size:10px;font-weight:700;">${a.pct}%</td>
              </tr>
            </table>
            `).join('')}

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:20px;border-collapse:collapse;border-radius:10px;overflow:hidden;">
              <tr style="background:#1e293b;">
                <td style="padding:10px 14px;font-size:12px;color:#fff;font-weight:600;">Type d'acte</td>
                <td style="padding:10px 14px;font-size:12px;color:#fff;font-weight:600;text-align:center;">Nombre</td>
                <td style="padding:10px 14px;font-size:12px;color:#fff;font-weight:600;text-align:right;">CA G√©n√©r√©</td>
              </tr>
              ${actesData.map((a, i) => `
              <tr style="background:${i % 2 === 0 ? '#ffffff' : '#f8fafc'};border-bottom:1px solid #f1f5f9;">
                <td style="padding:10px 14px;font-size:13px;color:#334155;">${a.icon} ${a.type}</td>
                <td style="padding:10px 14px;font-size:13px;color:#475569;text-align:center;">${a.nombre}</td>
                <td style="padding:10px 14px;font-size:13px;font-weight:700;color:#1e293b;text-align:right;">${fmtMoney(a.ca)} ‚Ç¨</td>
              </tr>
              `).join('')}
              <tr style="background:#1e293b;">
                <td style="padding:10px 14px;font-size:13px;color:#fff;font-weight:800;">TOTAL</td>
                <td style="padding:10px 14px;font-size:13px;color:#fff;font-weight:700;text-align:center;">${totalActes}</td>
                <td style="padding:10px 14px;font-size:13px;color:#10b981;font-weight:800;text-align:right;">${fmtMoney(totalCAActes)} ‚Ç¨</td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- RECOMMANDATIONS -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;padding-top:25px;">
              <tr>
                <td style="border-left:4px solid #f59e0b;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">üí° RECOMMANDATIONS</p>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:18px;border-left:4px solid #3b82f6;background:#eff6ff;border-radius:0 10px 10px 0;overflow:hidden;">
              <tr>
                <td style="padding:18px 20px;">
                  <p style="margin:0;font-size:14px;font-weight:700;color:#1e293b;">1. Optimiser le taux de conversion des devis (+5-10% potentiel)</p>
                  <ul style="margin:8px 0 0;padding-left:20px;color:#475569;font-size:13px;">
                    <li style="padding:3px 0;">Mettre en place un suivi syst√©matique des devis non accept√©s</li>
                    <li style="padding:3px 0;">Proposer des facilit√©s de paiement</li>
                  </ul>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:12px;border-left:4px solid #10b981;background:#f0fdf4;border-radius:0 10px 10px 0;overflow:hidden;">
              <tr>
                <td style="padding:18px 20px;">
                  <p style="margin:0;font-size:14px;font-weight:700;color:#1e293b;">2. Maintenir le bon taux de pr√©sence ‚úì</p>
                  <ul style="margin:8px 0 0;padding-left:20px;color:#475569;font-size:13px;">
                    <li style="padding:3px 0;">Envoyer des rappels SMS 48h et 24h avant le RDV</li>
                    <li style="padding:3px 0;">Mettre en place une politique de gestion des annulations</li>
                  </ul>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:12px;border-left:4px solid #f59e0b;background:#fffbeb;border-radius:0 10px 10px 0;overflow:hidden;">
              <tr>
                <td style="padding:18px 20px;">
                  <p style="margin:0;font-size:14px;font-weight:700;color:#1e293b;">3. D√©velopper l'activit√© proth√©tique</p>
                  <ul style="margin:8px 0 0;padding-left:20px;color:#475569;font-size:13px;">
                    <li style="padding:3px 0;">Fort potentiel de CA sur ce segment</li>
                    <li style="padding:3px 0;">Investir dans la formation continue</li>
                  </ul>
                </td>
              </tr>
            </table>

            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:12px;border-left:4px solid #ef4444;background:#fef2f2;border-radius:0 10px 10px 0;overflow:hidden;">
              <tr>
                <td style="padding:18px 20px;">
                  <p style="margin:0;font-size:14px;font-weight:700;color:#1e293b;">4. Fid√©lisation patients</p>
                  <ul style="margin:8px 0 0;padding-left:20px;color:#475569;font-size:13px;">
                    <li style="padding:3px 0;">Programme de rappel pour contr√¥les annuels</li>
                    <li style="padding:3px 0;">Communication r√©guli√®re (newsletter)</li>
                  </ul>
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- PROCHAINES √âTAPES -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-top:1px solid #e2e8f0;padding-top:25px;">
              <tr>
                <td style="border-left:4px solid #2563eb;padding-left:12px;">
                  <p style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">üìÖ PROCHAINES √âTAPES</p>
                </td>
              </tr>
            </table>
            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:15px;">
              <tr><td style="padding:10px 0;font-size:13px;color:#475569;">‚òê R√©union d'√©quipe pour pr√©senter les r√©sultats</td></tr>
              <tr><td style="padding:10px 0;font-size:13px;color:#475569;border-top:1px solid #f1f5f9;">‚òê Mise en place du syst√®me de rappels automatiques</td></tr>
              <tr><td style="padding:10px 0;font-size:13px;color:#475569;border-top:1px solid #f1f5f9;">‚òê Audit des devis en attente (&gt; 30 jours)</td></tr>
              <tr><td style="padding:10px 0;font-size:13px;color:#475569;border-top:1px solid #f1f5f9;">‚òê Formation sur les techniques de pr√©sentation des plans de traitement</td></tr>
            </table>
          </td>
        </tr>

        <!-- FOOTER -->
        <tr>
          <td style="padding:30px 40px 0;">
            <table width="100%" cellpadding="0" cellspacing="0" style="background:#1e293b;border-radius:12px;overflow:hidden;">
              <tr>
                <td style="padding:20px;text-align:center;">
                  <p style="margin:0;font-size:13px;color:#e2e8f0;">üìä Rapport g√©n√©r√© automatiquement par <strong>Efficience Analytics</strong></p>
                  <p style="margin:6px 0 0;font-size:11px;color:#94a3b8;">Date de g√©n√©ration : ${dateGeneration}</p>
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <tr>
          <td style="padding:15px 40px 25px;text-align:center;">
            <p style="margin:0;font-size:11px;color:#94a3b8;">¬© 2026 Efficience Dentaire - Plateforme s√©curis√©e HDS Certifi√©e</p>
          </td>
        </tr>

      </table>
    </td></tr>
  </table>
</body>
</html>`;
}

// Envoyer un rapport par email
async function sendReportEmail({ to, subject, practitionerName, mois, kpi, pdfBuffer, recommandations, cabinetName }) {
  try {
    const transporter = createTransporter();

    const htmlContent = buildEmailHTML({ practitionerName, mois, kpi, recommandations, cabinetName });

    const mailOptions = {
      from: `"üìä Efficience Analytics" <${process.env.EMAIL_USER}>`,
      to,
      subject,
      html: htmlContent,
      attachments: pdfBuffer ? [
        {
          filename: `rapport_${practitionerName.replace(/\s/g, '_')}_${mois.replace(/\s/g, '_')}.html`,
          content: pdfBuffer,
          contentType: 'text/html'
        }
      ] : []
    };

    const info = await transporter.sendMail(mailOptions);
    console.log(`‚úÖ Email envoy√© √† ${to}: ${info.messageId}`);
    return info;
  } catch (error) {
    console.error('‚ùå Erreur envoi email:', error);
    throw error;
  }
}

module.exports = { sendReportEmail, buildEmailHTML };
